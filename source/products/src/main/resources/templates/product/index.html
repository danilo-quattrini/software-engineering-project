<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{product/components/head :: head('Marketplace')}"></head>
<body class="bg-gray-50">
<div th:replace="~{product/components/navbar/navigation-bar :: navigation(${user.getSimpleRole()})}"></div>
<section class="py-8 antialiased md:py-12">
    <div class="mx-auto max-w-screen-xl px-4 2xl:px-0">
        <div th:replace="~{product/components/navbar/marketplace-links :: nav}"></div>

        <!--PRODUCT SECTION-->
        <h1 th:if="${user.getSimpleRole() == 'BUYER'}" class="text-5xl text-black mb-2 font-bold">Marketplace</h1>
        <div th:if="${user.getSimpleRole() == 'DISTRIBUTOR'
                        or user.getSimpleRole() == 'TRANSFORMER'
                        or user.getSimpleRole() == 'PRODUCER'}" class="space-y-2">
            <h1 class="text-5xl text-black font-bold">Product Dashboard</h1>
            <p class="text-gray-600">I nuovi prodotti rimangono nascosti finché il curatore non li approva.</p>
        </div>

        <hr class="my-5 w-[500px] text-white"/>
        <!-- Search Bar -->
        <div class="w-full sm:w-64 mb-2">
            <label for="searchInput" class="block mb-2 text-sm font-medium text-heading sr-only ">Search</label>
            <div class="relative">
                <input type="search" id="searchInput"
                       class="block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 shadow-sm placeholder:text-gray-400"
                       placeholder="Search products..."
                       autocomplete="off"/>
            </div>
        </div>

        <div class="mb-4 grid gap-4 sm:grid-cols-2 md:mb-8 lg:grid-cols-3 xl:grid-cols-4">
            <div th:each="product : ${products}" th:object="${product}"
                 class="product-card rounded-lg border border-gray-200 bg-white p-6 shadow-sm">

                <!-- PRODUCT IMAGE -->
                <div th:replace="~{product/components/card/card-image :: card-image}"></div>

                <!-- PRODUCT BODY -->
                <div class="pt-6">
                    <div class="mb-4 gap-4">
                        <div class="flex items-center justify-end gap-1">
                            <form th:if="${user.getSimpleRole() == 'BUYER'}"
                                  th:action="${favoriteIds != null and favoriteIds.contains(product.getId())} ?
                                             @{/favorites/remove/{uuid}(uuid=${product.getId()})} :
                                             @{/favorites/add/{uuid}(uuid=${product.getId()})}"
                                  th:method="POST">
                                <button type="submit" class="text-black">

                                    <span class="sr-only">Add to Favorites</span>

                                    <!-- RED HEART (product IS favorite) -->
                                    <svg th:if="${favoriteIds != null and favoriteIds.contains(product.getId())}"
                                         class="size-6"
                                         xmlns="http://www.w3.org/2000/svg"
                                         fill="red"
                                         viewBox="0 0 24 24">
                                        <path stroke="red" stroke-linecap="round" stroke-linejoin="round"
                                              stroke-width="2"
                                              d="M12 6C6.5 1 1 8 5.8 13l6.2 7 6.2-7C23 8 17.5 1 12 6Z"/>
                                    </svg>

                                    <!-- EMPTY HEART (product NOT favorite) -->
                                    <svg th:unless="${favoriteIds != null and favoriteIds.contains(product.getId())}"
                                         class="size-6"
                                         xmlns="http://www.w3.org/2000/svg"
                                         fill="none"
                                         viewBox="0 0 24 24">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                              stroke-width="2"
                                              d="M12 6C6.5 1 1 8 5.8 13l6.2 7 6.2-7C23 8 17.5 1 12 6Z"/>
                                    </svg>

                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="flex items-start justify-between gap-2">
                        <a th:text="*{name}" th:href="@{/products/{uuid}(uuid=*{id})}"
                           class="product-name text-lg font-semibold leading-tight text-gray-900 hover:underline">Example
                            Title</a>
                        <span th:if="${user.getSimpleRole() == 'DISTRIBUTOR'
                                        or user.getSimpleRole() == 'TRANSFORMER'
                                        or user.getSimpleRole() == 'PRODUCER'}"
                              th:switch="*{status}" class="px-3 py-1 rounded-full text-xs font-semibold"
                              th:classappend="*{status.name() == 'PENDING'} ? ' bg-amber-100 text-amber-800' :
                              (*{status.name() == 'APPROVED'} ? ' bg-green-100 text-green-700' : ' bg-red-100 text-red-700')"
                              th:text="*{status.name() == 'PENDING'} ? 'In revisione' :
                              (*{status.name() == 'APPROVED'} ? 'Approvato' : 'Rifiutato')"></span>
                    </div>
                    <div class="flex-1 py-2 text-2xl">
                        <p th:text="*{price + ' €'}"
                           class="text-2xl font-extrabold leading-tight text-gray-900">1.699$</p>
                    </div>
                    <ul class="mt-2 flex flex-col space-y-2">
                        <li>
                            <p th:text="*{category}"
                               class="w-fit text-sm font-medium text-black border border-black rounded-lg py-1 px-2">
                                Random
                                Category</p>
                        </li>

                        <li>
                            <p th:text="*{'Expire Date: ' + expireDate}" class="text-sm font-medium text-gray-500">
                                2025-12-12</p>
                        </li>

                    </ul>
                    <div class="mt-4 flex items-center justify-between gap-1">

                        <!-- EDIT OR DELETE PRODUCT -->
                        <div th:if="${user.getSimpleRole() == 'DISTRIBUTOR'
                                        or user.getSimpleRole() == 'TRANSFORMER'
                                        or user.getSimpleRole() == 'PRODUCER'
                                        or user.getSimpleRole() == 'TRUSTEE'}"
                             class="flex flex-1 space-x-2">
                            <a th:replace="~{product/components/form/button :: button('Edit', 'products/edit/' + *{id} , 'blue')}"></a>
                            <!--Delete From-->
                            <form th:action="@{/products/{uuid}(uuid=*{id})}" th:method="delete">
                                <input type="submit"
                                       class="inline-flex items-center rounded-lg px-5 py-2.5 text-sm font-medium focus:outline-none focus:ring-4 cursor-pointer transition-colors duration-300 bg-red-700 text-white hover:bg-red-800 focus:ring-red-300"
                                       value="Delete"/>
                            </form>
                        </div>

                        <!-- ADD TO CART -->
                        <div th:if="${user.getSimpleRole()} == 'BUYER'" class="flex float-start">
                            <form th:action="@{/cart/{uuid}(uuid=*{id})}" th:method="POST">
                                <button type="submit"
                                        class="inline-flex items-center rounded-lg px-5 py-2.5 text-sm focus:outline-none focus:ring-4 font-medium bg-blue-700 text-white hover:bg-blue-800 focus:ring-blue-300 transition-colors duration-300">
                                    <svg class="-ms-2 me-2 h-5 w-5" aria-hidden="true"
                                         xmlns="http://www.w3.org/2000/svg"
                                         width="24" height="24" fill="none" viewBox="0 0 24 24">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                              stroke-width="2"
                                              d="M4 4h1.5L8 16m0 0h8m-8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm.75-3H7.5M11 7H6.312M17 4v6m-3-3h6"/>
                                    </svg>
                                    Add to cart
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${user.getSimpleRole() == 'DISTRIBUTOR'
                        or user.getSimpleRole() == 'TRANSFORMER'
                        or user.getSimpleRole() == 'PRODUCER'}" class="w-full text-center">
            <a th:replace="~{/product/components/form/button :: button('New Product', 'products/create', 'white')}"> </a>
        </div>
    </div>
</section>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("searchInput");

        searchInput.addEventListener("input", function () {
            const term = searchInput.value.toLowerCase();
            const cards = document.querySelectorAll(".product-card");

            cards.forEach(card => {
                const name = card.querySelector(".product-name").textContent.toLowerCase();
                if (name.includes(term)) {
                    card.classList.remove("hidden");
                } else {
                    card.classList.add("hidden");
                }
            });
        });
    });
</script>
</body>
</html>