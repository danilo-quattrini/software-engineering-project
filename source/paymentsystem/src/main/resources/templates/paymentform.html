<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Pagina Pagamento</title>

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Map Scripts -->
    <script type="module">
        import MapComponent from '/js/osm/map-component.js';
        import { addDeliveryPointOnClick } from '/js/osm/modules/delivery-point/addDeliveryPointOnClick.js';
        import { addDeliveryPointByAddress } from '/js/osm/modules/delivery-point/addDeliveryPointByAddress.js';

        function updateFormFields({ latitude, longitude, address }) {
            document.querySelector('#address').value = address;
            document.querySelector('#lat').value = latitude;
            document.querySelector('#lng').value = longitude;
        }

        window.initMap = function () {
            const map = new MapComponent('map', {
                center: [41.9028, 12.4964],
                zoom: 6
            });

            map.use((mc) => addDeliveryPointOnClick(mc, updateFormFields));
            map.use((mc) => addDeliveryPointByAddress(mc, updateFormFields));
        };
    </script>

</head>

<body class="bg-gray-50 min-h-screen flex items-start justify-center py-10">

<div class="w-full max-w-3xl bg-white shadow-lg rounded-2xl p-8">
    <h3 class="text-2xl font-semibold text-center mb-6 text-gray-800">
        Pagamento di prova
    </h3>

    <!-- Importo -->
    <p class="text-lg text-gray-700 mb-4">
        Importo:
        <strong class="text-gray-900"
                th:text="${paymentDto.reference.amount} + ' ' + ${paymentDto.reference.currencyCode}">
        </strong>
    </p>

    <!-- Indirizzo (solo se non Ã¨ un evento) -->
    <div th:if="${!isEvent}" class="mb-6">
        <p class="text-gray-700">
            <strong>Indirizzo:</strong>
            <span th:text="${paymentDto.location != null ? paymentDto.location.address : ''}"></span>
        </p>
    </div>

    <form id="payment-form" class="space-y-6">

        <!-- Hidden fields -->
        <input type="hidden" id="referenceId" name="referenceId" th:value="${paymentDto.reference.id}"/>
        <input type="hidden" id="payerEmail" name="payerEmail" th:value="${paymentDto.payer.email}"/>

        <div th:if="${!isEvent}" class="space-y-4">

            <input type="hidden" id="address" name="address"/>
            <input type="hidden" id="lat" name="lat"/>
            <input type="hidden" id="lng" name="lng"/>

            <!-- Map Container -->
            <div class="rounded-lg overflow-hidden shadow border border-gray-300">
                <div id="map" class="w-full" style="height:400px;"></div>
            </div>

            <script>
                window.addEventListener('DOMContentLoaded', () => initMap());
            </script>
        </div>

        <!-- Pay Button -->
        <button type="button" id="pay-btn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-md transition duration-200">
            Paga con PSP Demo
        </button>
    </form>
</div>

<script type="module" src="/js/psp/pspscript.js"></script>

</body>
</html>
